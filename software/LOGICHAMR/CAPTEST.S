 LST OFF
 XC OFF
********************************
* CAPTEST - CAPTURE ENGINE TEST
* STANDALONE TEST FOR LOGIC HAMR
********************************
*
 DSK CAPTEST
 ORG $8000
 TYP $06
*
*-------------------------------
* ZERO PAGE VARIABLES
*-------------------------------
*
PTR EQU $06
COUNTER EQU $08
*
*-------------------------------
* HARDWARE REGISTERS (SLOT 4)
*-------------------------------
*
SLOTBASE EQU $C0C0
REG_CHAN EQU SLOTBASE+$00
REG_ADDR EQU SLOTBASE+$01
REG_DATA EQU SLOTBASE+$02
REG_CMD EQU SLOTBASE+$03
REG_STAT EQU SLOTBASE+$04
REG_STRCH EQU SLOTBASE+$05
REG_TRCH EQU SLOTBASE+$06
REG_TRMD EQU SLOTBASE+$07
REG_WIN EQU SLOTBASE+$08
REG_ARM EQU SLOTBASE+$09
REG_DBG EQU SLOTBASE+$0A
*
* STATUS BITS
ST_BUSY EQU $01
ST_RDY EQU $02
ST_ARM EQU $04
ST_CAP EQU $08
*
* COMMANDS
CMD_READ EQU $02
CMD_REGN EQU $10
*
*-------------------------------
* APPLE II ROM ROUTINES
*-------------------------------
*
BELL EQU $FF3A
COUT EQU $FDED
CROUT EQU $FD8E
PRBYTE EQU $FDDA
HOME EQU $FC58
*
*-------------------------------
* MAIN PROGRAM
*-------------------------------
*
START
 JSR HOME
*
* PRINT TITLE
 LDA #<TITLE
 LDY #>TITLE
 JSR PRINT
*
* STEP 1: CONFIGURE TRIGGER
 LDA #<MSG_CFG
 LDY #>MSG_CFG
 JSR PRINT
*
 LDA #$00
 STA REG_DBG            ;DISABLE DEBUG PATTERN - USE REAL PROBES
*
 LDA #$00
 STA REG_TRCH           ;TRIGGER ON CHANNEL 0 (GPIO5)
*
 LDA #$00
 STA REG_TRMD           ;RISING EDGE TRIGGER
*
 LDA #$01
 STA REG_WIN            ;WINDOW PRESET 1 (88 SAMPLES)
*
 LDA #<MSG_OK
 LDY #>MSG_OK
 JSR PRINT
*
* STEP 2: ARM CAPTURE
 LDA #<MSG_ARM
 LDY #>MSG_ARM
 JSR PRINT
*
 LDA #$01
 STA REG_ARM
*
* STEP 3: WAIT FOR CAPTURE
 LDA #<MSG_WAIT
 LDY #>MSG_WAIT
 JSR PRINT
*
:WAITCAP
 LDA REG_STAT
 AND #ST_CAP
 BEQ :WAITCAP
*
 LDA #<MSG_CAP
 LDY #>MSG_CAP
 JSR PRINT
*
* STEP 4: BELL
 JSR BELL
*
* STEP 5: REGENERATE DISPLAY
 LDA #<MSG_REGN
 LDY #>MSG_REGN
 JSR PRINT
*
 LDA #CMD_REGN
 STA REG_CMD
*
:WAITRGN
 LDA REG_STAT
 AND #ST_RDY
 BEQ :WAITRGN
*
 LDA #<MSG_OK
 LDY #>MSG_OK
 JSR PRINT
*
* STEP 6: DUMP FIRST 10 BYTES
 JSR CROUT
 LDA #<MSG_DUMP
 LDY #>MSG_DUMP
 JSR PRINT
*
 LDA #$00
 STA REG_CHAN
 STA COUNTER
*
:DMPLOOP
 LDA COUNTER
 STA REG_ADDR
*
 LDA #CMD_READ
 STA REG_CMD
*
:WAITRD
 LDA REG_STAT
 AND #ST_BUSY
 BNE :WAITRD
*
 LDA REG_DATA
 JSR PRBYTE
 LDA #" "
 JSR COUT
*
 INC COUNTER
 LDA COUNTER
 CMP #10
 BCC :DMPLOOP
*
 JSR CROUT
 JSR CROUT
*
 LDA #<MSG_DONE
 LDY #>MSG_DONE
 JSR PRINT
*
 JSR BELL
 RTS
*
*-------------------------------
* PRINT NULL-TERMINATED STRING
* A=LOW, Y=HIGH OF STRING ADDR
*-------------------------------
*
PRINT
 STA PTR
 STY PTR+1
 LDY #0
:PLOOP
 LDA (PTR),Y
 BEQ :PDONE
 ORA #$80
 JSR COUT
 INY
 BNE :PLOOP
:PDONE
 RTS
*
*-------------------------------
* MESSAGES (NULL-TERMINATED)
*-------------------------------
*
TITLE ASC "================================"0D
 ASC " LOGIC HAMR CAPTURE TEST"0D
 ASC "================================"0D0D00
*
MSG_CFG ASC "CONFIG: CH0/GPIO5, RISE, 88US..."00
*
MSG_OK ASC " OK"0D00
*
MSG_ARM ASC "ARMING CAPTURE..."0D00
*
MSG_WAIT ASC "WAITING FOR GPIO5 RISING EDGE..."00
*
MSG_CAP ASC " CAPTURED!"0D00
*
MSG_REGN ASC "REGENERATING..."00
*
MSG_DUMP ASC "CHANNEL 0, BYTES 0-9:"0D00
*
MSG_DONE ASC "TEST COMPLETE!"0D00
*
